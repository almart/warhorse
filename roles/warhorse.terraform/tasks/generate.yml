---
- name: Create Terraform directories
  ansible.builtin.file:
    path: '{{ item.folder }}'
    state: directory
    mode: '0755'
  loop:
    - { folder: "{{ terraform_project_path }}" }

- name: Ensure warhorse variable has required keys
  set_fact:
    warhorse: "{{ warhorse | default({}) | combine({'providers': {}, 'terraform': {}}) }}"

- name: Generating Terraform Variables
  template:
    src: templates/terraform_variables.tf.j2
    dest: "{{ terraform_project_path }}/variables.tf"
  vars:
    warhorse: "{{ warhorse }}"

- name: Generating Terraform Providers
  template:
    src: templates/terraform_provider.tf.j2
    dest: "{{ terraform_project_path }}/provider.tf"
  vars:
    warhorse: "{{ warhorse }}"

# Include Azure tasks if "provider": "azure" appears in warhorse
- ansible.builtin.include_tasks: azure.yml
  when: (warhorse | to_nice_json | regex_search('(?i).*"provider"\s*:\s*"azure".*')) | bool
  vars:
    warhorse: "{{ warhorse }}"

- include: digitalocean.yml
  when: warhorse | regex_search("(?i).+('provider':\s'digitalocean')", multiline=True, ignorecase=True)
- include: linode.yml
  when: warhorse | regex_search("(?i).+('provider':\s'linode')", multiline=True, ignorecase=True)
- include: aws.yml
  when: warhorse | regex_search("(?i).+('provider':\s'aws')", multiline=True, ignorecase=True)

- name: Generating Terraform Outputs
  template:
    src: templates/terraform_outputs.tf.j2
    dest: "{{ terraform_project_path }}/outputs.tf"

- name: Generating Terraform Inventory Template
  template:
    src: templates/inventory.tmpl.j2
    dest: "{{ terraform_project_path }}/inventory.tmpl"

- name: Generating Terraform aws Template
  template:
    src: templates/aws.tmpl.j2
    dest: "{{ terraform_project_path }}/aws.tmpl"
