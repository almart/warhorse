---
{% if warhorse.terraform.state_bucket_enabled is defined and warhorse.terraform.state_bucket_enabled is true %}
- name: Create Terraform Backend Configuration File
  copy:
    dest: "{% raw %}{{ terraform_path }}{% endraw %}/backend.hcl"
    content: |
      region = "{% raw %}{{ warhorse.terraform.state_bucket_region }}{% endraw %}"
      bucket = "{% raw %}{{ warhorse.terraform.state_bucket_name }}{% endraw %}"
      key    = "{% raw %}{{ terraform_state_bucket_key }}{% endraw %}"
      access_key = "{% raw %}{{ bucket_access_key }}{% endraw %}"
      secret_key = "{% raw %}{{ bucket_secret_key }}{% endraw %}"
      endpoints = {
        s3 = "{% raw %}{{ warhorse.terraform.state_bucket_endpoint }}{% endraw %}"
      }
  when: warhorse.terraform.state_bucket_enabled

- name: Initialize Terraform with Backend Config
  command:
    cmd: >
      terraform init -input=false -no-color
      -backend-config="{% raw %}{{ terraform_path }}{% endraw %}/backend.hcl"
  args:
    chdir: "{% raw %}{{ terraform_path }}{% endraw %}"

{% endif %}

{% if warhorse.terraform.state_bucket_enabled is not defined and warhorse.terraform.cloud_enabled is not defined %}
- name: "{% raw %}{{ name }}{% endraw %} Terraform Local State"
  community.general.terraform:
    project_path: "{% raw %}{{ terraform_path }}{% endraw %}"
    state: "{% raw %}{{ state }}{% endraw %}"
    force_init: true
    variables:
{% if warhorse.terraform.digitalocean_token is defined %}
      do_token: "{% raw %}{{ digitalocean_token }}{% endraw %}"
{% endif %}
{% if warhorse.terraform.linode_token is defined %}
      linode_token: "{% raw %}{{ linode_token }}{% endraw %}"
{% endif %}
{% if warhorse.terraform.cloudflare_token is defined %}
      cloudflare_token: "{% raw %}{{ cloudflare_token }}{% endraw %}"
{% endif %}
{% endif %}

{% if warhorse.terraform.cloud_enabled is defined and warhorse.terraform.cloud_enabled is true %}
- name: "{% raw %}{{ name }}{% endraw %} Terraform Cloud"
  community.general.terraform:
    project_path: "{% raw %}{{ terraform_path }}{% endraw %}"
    state: "{% raw %}{{ state }}{% endraw %}"
    workspace: "{% raw %}{{ warhorse.terraform.cloud_workspace }}{% endraw %}"
    force_init: true
    variables:
{% if warhorse.terraform.digitalocean_token is defined %}
      do_token: "{% raw %}{{ digitalocean_token }}{% endraw %}"
{% endif %}
{% if warhorse.terraform.linode_token is defined %}
      linode_token: "{% raw %}{{ linode_token }}{% endraw %}"
{% endif %}
{% if warhorse.terraform.cloudflare_token is defined %}
      cloudflare_token: "{% raw %}{{ cloudflare_token }}{% endraw %}"
{% endif %}
{% endif %}
