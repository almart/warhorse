---
- name: Deploy Terraform
  hosts: localhost
  gather_facts: true
  connection: local
  no_log: false
  tasks:
  - name: Start
    set_fact:
      start_time: "{% raw %}{{ ansible_date_time.iso8601[:19] }}{% endraw %}"
  vars: 
    deploy: true
  roles:
    - { role: terraform }

- name: Refresh Inventory & unlock SSH Key
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:
    - name: Verify SSH key file exists
      stat:
        path: "{{ ansible_ssh_private_key_file }}"
      register: ssh_key_stat

    - name: Fail if SSH key file does not exist
      fail:
        msg: "SSH key file does not exist: {{ ansible_ssh_private_key_file }}"
      when: not ssh_key_stat.stat.exists

    - name: Start SSH agent if not running
      shell: |
        if [ -z "$SSH_AUTH_SOCK" ]; then
          eval $(ssh-agent -s)
        fi
        echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
        echo "SSH_AGENT_PID=$SSH_AGENT_PID"
      register: ssh_agent
      changed_when: false

    - name: Debug SSH agent output
      debug:
        var: ssh_agent.stdout_lines

    - name: Set SSH agent environment variables fact
      set_fact:
        ssh_auth_sock: >-
          {{
            (ssh_agent.stdout_lines |
            select('search', '^SSH_AUTH_SOCK=') |
            list | first | regex_replace('^SSH_AUTH_SOCK=', ''))
            | default(lookup('env','SSH_AUTH_SOCK'))
          }}
        ssh_agent_pid: >-
          {{
            (ssh_agent.stdout_lines |
            select('search', '^SSH_AGENT_PID=') |
            list | first | regex_replace('^SSH_AGENT_PID=', ''))
            | default(lookup('env','SSH_AGENT_PID'))
          }}
      when: ssh_agent is defined

    - name: Debug SSH agent facts
      debug:
        msg: "SSH_AUTH_SOCK={{ ssh_auth_sock }}, SSH_AGENT_PID={{ ssh_agent_pid }}"

    - name: Add SSH key to agent
      expect:
        command: ssh-add "{{ ansible_ssh_private_key_file }}"
        responses:
          passphrase: "{{ ssh_passphrase }}"
        timeout: 60
      environment:
        SSH_AUTH_SOCK: "{{ ssh_auth_sock }}"
        SSH_AGENT_PID: "{{ ssh_agent_pid }}"
      delegate_to: 127.0.0.1
      become: no
      changed_when: no
      no_log: false

    - name: Debug SSH key unlocked
      debug:
        msg: "SSH key {{ ansible_ssh_private_key_file }} unlocked successfully"

    - name: Gathering facts
      setup:

    - meta: refresh_inventory

    - name: Wait for system to become reachable again
      wait_for_connection:
        delay: 10
        timeout: 300



- name: Apt Ready
  gather_facts: yes
  hosts: warhorse
  connection: ssh
  become: true
  no_log: true
  vars: 
    deploy: true
  tasks:
  - name: Apt for sure
    apt: update_cache=yes
    register: apt_status
    until: apt_status is success
    delay: 10
    retries: 10 

{% for vm in warhorse.vm %}  
{% if loop.first %}
- name: Install Roles
  gather_facts: yes
  hosts: warhorse
  connection: ssh
  become: true
  no_log: true
  vars: 
    deploy: true
  roles:
{% if warhorse.general.snapshots is undefined or false %}
    - { role: weareinteractive.users }
    - { role: geerlingguy.pip }
    - { role: geerlingguy.docker }
    - { role: warhorse.os }
    - { role: geerlingguy.ntp }
    - { role: geerlingguy.security }
    - { role: viasite-ansible.zsh, zsh_shared: yes}
{% endif %}
{% if warhorse.general.snapshots is defined and true %}
    - { role: weareinteractive.users }
    - { role: warhorse.os }
    - { role: viasite-ansible.zsh, zsh_shared: yes}
{% endif %}
{% if vm.backup is defined %}
    - { role: arillso.restic }
{% endif %}
{% endif %}
{% endfor %}
{% for vm in warhorse.vm %}

- name: Install Modules
  gather_facts: True
  hosts: {{ vm.name }}
  connection: ssh
  become: true
  no_log: true
  vars: 
    deploy: true
  roles:
{% if warhorse.vpn.tailscale is defined and vm.tailscale is defined %}
    - { role: artis3n.tailscale }
{% endif %}
{% if vm.golang is defined %}
    - { role: gantsign.golang }
{% endif %}
{% if vm.http_proxy is defined and vm.http_proxy == "traefik" %}
    - { role: warhorse.traefik_docker }
{% endif %}
{% if vm.http_proxy is defined and vm.http_proxy == "nginx" %}
    - { role: warhorse.nginx_docker }
{% endif %}
{% if vm.cobaltstrike is defined %}
    - { role: warhorse.cobaltstrike_docker }
{% endif %}
{% if vm.gophish is defined %}
    - { role: warhorse.gophish_docker }
{% endif %}
{% if vm.mythic is defined %}
    - { role: t94j0.mythic }
    - { role: warhorse.swag_docker }
{% endif %}
{% if vm.neo4j is defined %}
    - { role: warhorse.neo4j_docker }
{% endif %}
{% if vm.syncthing is defined %}
    - { role: warhorse.syncthing_docker }
{% endif %}
{% if vm.tailscale is defined %}
    - { role: warhorse.tailscale }
{% endif %}
{% if vm.dashy is defined %}
    - { role: warhorse.dashy_docker }
{% endif %}
{% if vm.evilginx2 is defined %}
    - { role: warhorse.evilginx2_docker }
{% endif %}
{% if vm.mitmproxy is defined %}
    - { role: warhorse.mitmproxy_docker }
{% endif %}
{% if vm.nighthawk is defined %}
    - { role: warhorse.nighthawk_docker }
{% endif %}
{% endfor %}

{% if warhorse.general.deployment_txt is undefined or warhorse.general.deployment_txt is true %}
- name: Deployment Extras
  gather_facts: yes
  hosts: warhorse
  connection: ssh
  become: true
  no_log: false
  vars: 
    deploy: true
  roles:
    - { role: deployment }
{% if warhorse.notification.email is defined %}
    - { role: warhorse.notification }
{% endif %}
{% endif %}

- name: Run Time
  hosts: localhost
  gather_facts: true
  connection: local
  tasks:
  - name: force update of current timestamp
    setup: filter='ansible_date_time'
  - name: Get runtime
    set_fact:
      runtime: "{% raw %}{{ ((ansible_date_time.iso8601[:19] | to_datetime('%Y-%m-%dT%H:%M:%S')) - (start_time | to_datetime('%Y-%m-%dT%H:%M:%S'))) }}{% endraw %}"
  - debug:
      msg: "Playbook Runtime {% raw %}{{ runtime }}{% endraw %}"
